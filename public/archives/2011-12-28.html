<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>一次被入侵和删除木马程序的经历 | 千夜同学</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="http://70data.net/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="http://70data.net/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="http://70data.net/favicon-16x16.png">
    <link rel="manifest" href="http://70data.net/manifest.json">
    <link rel="mask-icon" href="http://70data.net/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="http://70data.net/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css"/>

    
    
    

    
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="http://70data.net/">千夜同学</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="http://70data.net/about/">About</a>
  
  </div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>



	<script src="http://70data.net/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">一次被入侵和删除木马程序的经历</h1>
    
    <time>December 28, 2011</time>
    
    <div>
        <p>
        <p>木马名称 Linux.BackDoor.Gates.5</p>
<p>中午服务器出现流量超高，平时只有几百 M 的流量，那时候发现流量上 G 了，而且提示阿里云有 DDOS 流量攻击行为。</p>
<p>开始也没有什么头绪，就是 ps 查进程，netstat 查端口号，nload 查流量。一时也没发现什么异常。</p>
<p>后来发现 root 的家目录下存在 conf.n 这个文件。</p>
<p>然而我并未创建这个文件，也是感觉问题来了。</p>
<p>/bin/ps,/bin/netsta 程序都是1.2M的大小，然后默认的只有几百 KB。</p>
<p><img src="http://70data.net/usr/uploads/2016/01/1890913733.png" alt="木马截图.png"></p>
<p>上传正常的二进制程序如：ls，netstat。</p>
<p>这些木马程序名字变着花样来，但万变不离其宗，名字都写在 <code>/etc/rc.d/init.d/DbSecuritySpt</code> 和 <code>/etc/rc.d/init.d/selinux</code> 里面，而且名字和正常的服务很像。</p>
<p>1.简单判断有无木马 有无下列文件</p>
<pre><code>cat /etc/rc.d/init.d/selinux
cat /etc/rc.d/init.d/DbSecuritySpt
ls /usr/bin/bsd-port 
ls /usr/bin/dpkgd
</code></pre><p>2.查看大小是否正常</p>
<pre><code>ls -lh /bin/netstat
ls -lh /bin/ps
ls -lh /usr/sbin/lsof
ls -lh /usr/sbin/ss
</code></pre><p>3.上传如下命令到 /root 下</p>
<pre><code>ps netstat ss lsof
</code></pre><p>4.删除如下目录及文件</p>
<pre><code>rm -rf /usr/bin/dpkgd （ps netstat lsof ss）
rm -rf /usr/bin/bsd-port  (木马程序）
rm -f  /usr/local/zabbix/sbin/zabbix_AgentD （木马程序）
rm -f  /usr/local/zabbix/sbin/conf.n
rm -f  /usr/bin/.sshd 
rm -f  /usr/bin/sshd 
rm -f  /root/cmd.n
rm -f  /root/conf.n
rm -f  /root/IP
rm -f  /tmp/gates.lod   
rm -f  /tmp/moni.lod
rm -f  /tmp/notify.file （程序）
rm -f  /tmp/gates.lock （进程号）
rm -f  /etc/rc.d/init.d/DbSecuritySpt （启动上述描述的那些木马变种程序）
rm -f  /etc/rc.d/rc1.d/S97DbSecuritySpt
rm -f  /etc/rc.d/rc2.d/S97DbSecuritySpt
rm -f  /etc/rc.d/rc3.d/S97DbSecuritySpt
rm -f  /etc/rc.d/rc4.d/S97DbSecuritySpt
rm -f  /etc/rc.d/rc5.d/S97DbSecuritySpt
rm -f  /etc/rc.d/init.d/selinux （默认是启动/usr/bin/bsd-port/getty）
rm -f  /etc/rc.d/rc1.d/S99selinux
rm -f  /etc/rc.d/rc2.d/S99selinux
rm -f  /etc/rc.d/rc3.d/S99selinux
rm -f  /etc/rc.d/rc4.d/S99selinux
rm -f  /etc/rc.d/rc5.d/S99selinux
</code></pre><p>5.找出下列程序进程号并杀死</p>
<p>top 一眼就看到那个木马 cpu 利用率特高</p>
<pre><code>/root/ps aux |grep -i jul29 （主要是最近开启的进程）
/root/ps aux |grep -i jul30
/root/ps aux |grep -i jul31
/root/ps aux |grep sshd
/root/ps aux |grep ps
/root/ps aux |grep getty
/root/ps aux |grep netstat
/root/ps aux |grep lsof
/root/ps aux |grep ss
/root/ps aux |grep zabbix_Agetntd
/root/ps aux |grep .dbus
</code></pre><p>6.查看 DNS 文件是不是被更改了</p>
<pre><code>cat /etc/resolv.conf 
</code></pre><p>7.工具扫描</p>
<p>安装杀毒工具</p>
<pre><code>yum -y install clamav*
</code></pre><p>启动</p>
<pre><code>service clamd restart
</code></pre><p>更新病毒库</p>
<pre><code>freshclam
</code></pre><p>扫描方法</p>
<pre><code>clamscan -r /etc --max-dir-recursion=5 -l /root/etcclamav.log
clamscan -r /bin --max-dir-recursion=5 -l /root/binclamav.log
clamscan -r /usr --max-dir-recursion=5 -l /root/usrclamav.log
clamscan -r  --remove  /usr/bin/bsd-port 
clamscan -r  --remove  /usr/bin/ 
clamscan -r --remove  /usr/local/zabbix/sbin
</code></pre><p>查看日志发现</p>
<pre><code>/bin/netstat: Linux.Trojan.Agent FOUND
/usr/bin/.sshd: Linux.Trojan.Agent FOUND
/usr/sbin/ss: Linux.Trojan.Agent FOUND
/usr/sbin/lsof: Linux.Trojan.Agent FOUND
</code></pre>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="http://70data.net/tags/Linux">#Linux</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="http://70data.net/css/katex.min.css" crossorigin="anonymous">
<script type="text/javascript" src="http://70data.net/js/katex.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="http://70data.net/js/auto-render.min.js"onload="renderMathInElement(document.body);" crossorigin="anonymous"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>



	<script src="http://70data.net/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>