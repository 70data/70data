<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>TCPCopy 常见问题 | 千夜同学</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="http://70data.net/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="http://70data.net/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="http://70data.net/favicon-16x16.png">
    <link rel="manifest" href="http://70data.net/manifest.json">
    <link rel="mask-icon" href="http://70data.net/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="http://70data.net/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css"/>

    
    
    

    
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="http://70data.net/">千夜同学</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="http://70data.net/about/">About</a>
  
  </div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>



	<script src="http://70data.net/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">TCPCopy 常见问题</h1>
    
    <time>June 18, 2015</time>
    
    <div>
        <p>
        <p>TCPCopy 常见问题:
出现 timeout 或者是频繁丢包</p>
<pre><code>sysctl -w net.core.rmem_max=131071
sysctl -w net.core.wmem_max=131071
sysctl -p
</code></pre><p>虚拟机使用 ab 测试的结果
会有包堆积的情况 不会马上处理 在 ab 测试数据跑完后 依然在处理数据包</p>
<pre><code>10000    100    缺包不明显
10000    500    出现 ack 处理异常 缺包不明显
10000    1000   出现 ack 处理异常 缺包不明显 有内存堆积不到 1MB 
10000    2000   出现 ack 处理异常 缺包明显 3000 左右 有内存堆积 11MB
20000    500    出现 ack 处理异常 缺包不明显 有内存堆积 11MB
20000    1000   出现 ack 处理异常 缺包明显 13000 左右 有内存堆积 21MB
20000    2000   出现 ack 处理异常 缺包明显 13000 左右 有内存堆积 28MB
</code></pre><p>notrack</p>
<pre><code>--with-single nfqueue
</code></pre><p>通过 cat /proc/net/ip_queue，查看 ip queue 运行情况</p>
<p>如果 Queue dropped 的数值不断增大，则需要修改 ip_queue_maxlen 参数，比如 echo 4096 &gt; /proc/sys/net/ipv4/ip_queue_maxlen</p>
<p>如果 Netlink dropped 的数值不断增大，修改 net.core.rmem_max 和 net.core.wmem_max 参数，比如 sysctl -w net.core.rmem_max=16777216 和 sysctl -w net.core.wmem_max=16777216</p>
<pre><code>echo &quot;1024 65535&quot; &gt; /proc/sys/net/ipv4/ip_local_port_range
echo &quot;1&quot; &gt; /proc/sys/net/ipv4/tcp_tw_recycle
echo &quot;1&quot; &gt; /proc/sys/net/ipv4/tcp_tw_reuse

cat /proc/sys/net/ipv4/ip_local_port_range
cat  /proc/sys/net/ipv4/tcp_tw_recycle
cat  /proc/sys/net/ipv4/tcp_tw_reuse

echo &quot;32768   61000&quot;  | sudo tee /proc/sys/net/ipv4/ip_local_port_range
echo 0 | sudo tee /proc/sys/net/ipv4/tcp_tw_recycle
echo 0 | sudo tee /proc/sys/net/ipv4/tcp_tw_reuse

sion size:235
activate_dead_sessions
user time used:8
sys  time used:28
max memory size:55412

[notice] init for next sess from bak
[notice] ack more than vir next seq
echo &quot;32768   61000&quot;  | sudo tee /proc/sys/net/ipv4/ip_local_port_range
</code></pre><p>频繁出现 ack more than vir next seq 的情况</p>
<p><img src="http://70data.net/usr/uploads/2015/07/2432934275.png" alt="ack more than vir next seq.png"></p>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="http://70data.net/tags/TCPCopy">#TCPCopy</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="http://70data.net/css/katex.min.css" crossorigin="anonymous">
<script type="text/javascript" src="http://70data.net/js/katex.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="http://70data.net/js/auto-render.min.js"onload="renderMathInElement(document.body);" crossorigin="anonymous"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>



	<script src="http://70data.net/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>