<!DOCTYPE html>

<html lang="zh-cn">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>排查 Logstash 2.4 升级到 5.0 版本后 Kafka 不兼容问题 | 千夜同学</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="http://70data.net/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="http://70data.net/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="http://70data.net/favicon-16x16.png">
    <link rel="manifest" href="http://70data.net/manifest.json">
    <link rel="mask-icon" href="http://70data.net/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="http://70data.net/css/main.min.15431d6c334f65809fe2bc329da3f2c81c6e3027ab1e25b56afb2bb85fa7fd64.css"/>

    
    
    

    
    </head>

    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="http://70data.net/">千夜同学</a>
    </div>  
</header>

  <div class="nav-menu">
  
    <a class="color-link nav-link" href="http://70data.net/about/">About</a>
  
  </div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>



	<script src="http://70data.net/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
</nav>

        <div id="content" class="content-container">
        

<h1 class="post-title">排查 Logstash 2.4 升级到 5.0 版本后 Kafka 不兼容问题</h1>
    
    <time>November 16, 2016</time>
    
    <div>
        <p>
        <p>之前对 ELKB 环境从 2.4 版本升级到最新的 5.0 稳定版本，发现 Kafka 集群运行报错，现在把排查过程记录下。</p>
<p>之前环境：</p>
<p>logstash2.4</p>
<p>logstash-input-kafka-2.0.9</p>
<p>logstash-output-kafka-2.0.5</p>
<p>kafka_2.10-0.8.2.2.tgz</p>
<p>升级后环境：</p>
<p>logstash5.0</p>
<p>logstash-input-kafka-2.0.9</p>
<p>logstash-output-kafka-2.0.5</p>
<p>报错信息：</p>
<pre><code>[2016-11-16T14:35:44,739][ERROR][logstash.inputs.kafka] Unknown setting 'zk_connect' for kafka
[2016-11-16T14:35:44,741][ERROR][logstash.inputs.kafka] Unknown setting 'topic_id' for kafka
[2016-11-16T14:35:44,741][ERROR][logstash.inputs.kafka] Unknown setting 'reset_beginning' for kafka
</code></pre>
<p>实施步骤：</p>
<p>1.根据错误查看程序哪里报错</p>
<pre><code>grep  &quot;Unknown setting&quot; /usr/share/logstash/ -R
/usr/share/logstash/logstash-core/lib/logstash/config/mixin.rb:self.logger.error(&quot;Unknown setting '#{name}' for #{@plugin_name}&quot;)
</code></pre>
<p>2，查看程序相关代码，发现需要查看 plugins 的 config 定义文件等</p>
<pre><code>def validate_check_invalid_parameter_names(params)
  invalid_params = params.keys
  # Filter out parameters that match regexp keys.
  # These are defined in plugins like this:
  #   config /foo.*/ =&gt; ...
  @config.each_key do |config_key|
    if config_key.is_a?(Regexp)
      invalid_params.reject! { |k| k =~ config_key }
    elsif config_key.is_a?(String)
      invalid_params.reject! { |k| k == config_key }
    end
  end

  if invalid_params.size &gt; 0
    invalid_params.each do |name|
      self.logger.error(&quot;Unknown setting '#{name}' for #{@plugin_name}&quot;)
    end
    return false
  end # if invalid_params.size &gt; 0
  return true
end # def validate_check_invalid_parameter_names
</code></pre>
<p>3，进入插件总目录查看具体信息</p>
<pre><code>cd  /usr/share/logstash/vendor/bundle/jruby/1.9/gems/logstash-input-kafka-5.0.5
</code></pre>
<p>发现重点查看如下文件</p>
<pre><code>grep config ./* -R |awk '{print $1}' |uniq 
./CHANGELOG.md:
./DEVELOPER.md:See
./lib/logstash/inputs/kafka.rb:#
./lib/logstash/inputs/kafka.rb:
./README.md:-
Binary
</code></pre>
<p>1）首先看 CHANGELOG.md，就有发现 logstash-input-3.0.0.beta1 开始就不在向后兼容，且剔除了 jruby-kafka，4.0.0 版本说开始支持 Kafka 0.9，5.0.0 又说开始支持 0.10 切不向后兼容。看来问题找到了，Kafka 版本是 kafka_2.10-0.8.2.2.tgz，Kafka 版本不兼容导致的。</p>
<p>CHANGELOG.md 部分文档如下：</p>
<pre><code>## 5.0.4
  - Update to Kafka version 0.10.0.1 for bug fixes
## 5.0.0
  - Support for Kafka 0.10 which is not backward compatible with 0.9 broker.
## 4.0.0
  - Republish all the gems under jruby.
  - Update the plugin to the version 2.0 of the plugin api, this change is required for Logstash 5.0 compatibility. See https://github.com/elastic/logstash/issues/5141
  - Support for Kafka 0.9 for LS 5.x
## 3.0.0.beta1
 - Refactor to use new Java based consumer, bypassing jruby-kafka
 - Breaking: Change configuration to match Kafka's configuration. This version is not backward compatible
</code></pre>
<p>2）之前看 DEVELOPER.md 文档时，看配置语法都正确，还以为是却少依赖关系 jruby-kafka library 呢，这个在 logstash2.x 是可以使用的。另外 Kafka 版本写的是 0.8.1.1，看来这个 DEVELOPER.md 没有及时更新，与后面 kafka.rb 文件不一致。</p>
<p>DEVELOPER.md 文档结尾如下：</p>
<pre><code>Dependencies
====================
* Apache Kafka version 0.8.1.1
* jruby-kafka library
</code></pre>
<p>3）开始看 README.md 文档，特意看了下 Kafka 的兼容性，看来 logstas-input-kafka5.0.5 和 logstash-output-kafka5.0.4 只能用 kafka0.10 了。如果你想用 kafka0.9 还想用 logstash5.0，你的 logstash-input-kafka 和 logstash-output-kafka 只能降级版本到 4.0.0 了。</p>
<pre><code>### Kafka Compatibility
Here's a table that describes the compatibility matrix for Kafka Broker support. Please remember that it is good advice to upgrade brokers before consumers/producers since brokers target backwards compatibility. The 0.9 broker will work with both the 0.8 consumer and 0.9 consumer APIs but not the other way around.

| Kafka Broker Version | Logstash Version | Input Plugin | Output Plugin | Why? |
|----------------------|------------------|--------------|---------------|------|
| 0.8  | 2.0 - 2.x   | &lt; 3.0.0 | &lt;3.0.0 | Legacy, 0.8 is still popular |
| 0.9  | 2.0 - 2.3.x | 3.0.0   | 3.0.0  | Intermediate release before 0.10 that works with old Ruby Event API `[]` |
| 0.9  | 2.4, 5.0    | 4.0.0   | 4.0.0  | Intermediate release before 0.10 with new get/set API |
| 0.10 | 2.4, 5.0    | 5.0.0   | 5.0.0  | Track latest Kafka release. Not compatible with 0.9 broker | 
</code></pre>
<p>4）现在看来只能升级 Kafka 版本了。最后我看了下 jar-dependencies 发现了 kafka-clients-0.10.0.1.jar</p>
<pre><code>ls /usr/share/logstash/vendor/bundle/jruby/1.9/gems/logstash-input-kafka-5.0.5/vendor/jar-dependencies/runtime-jars/
kafka-clients-0.10.0.1.jar  log4j-1.2.17.jar  lz4-1.3.0.jar  slf4j-api-1.7.21.jar  slf4j-log4j12-1.7.21.jar  snappy-java-1.1.2.6.jar
</code></pre>
<p>5）/usr/share/logstash/vendor/bundle/jruby/1.9/gems/logstash-input-kafka-5.0.5/lib/logstash/inputs/kafka.rb</p>
<p>kafka.rb 部分文档如下：</p>
<pre><code># This input will read events from a Kafka topic. It uses the the newly designed
# 0.10 version of consumer API provided by Kafka to read messages from the broker.
#
# Here's a compatibility matrix that shows the Kafka client versions that are compatible with each combination
# of Logstash and the Kafka input plugin: 
# 
# [options=&quot;header&quot;]
# |==========================================================
# |Kafka Client Version |Logstash Version |Plugin Version |Security Features |Why?
# |0.8 |2.0.0 - 2.x.x|&lt;3.0.0 | |Legacy, 0.8 is still popular 
# |0.9 |2.0.0 - 2.3.x| 3.x.x |Basic Auth, SSL|Works with the old Ruby Event API (`event['product']['price'] = 10`)  
# |0.9 |2.4.0 - 5.0.x| 4.x.x |Basic Auth, SSL|Works with the new getter/setter APIs (`event.set('[product][price]', 10)`)
# |0.10|2.4.0 - 5.0.x| 5.x.x |Basic Auth, SSL|Not compatible with the 0.9 broker 
# |==========================================================
# 
# NOTE: We recommended that you use matching Kafka client and broker versions. During upgrades, you should
# upgrade brokers before clients because brokers target backwards compatibility. For example, the 0.9 broker
# is compatible with both the 0.8 consumer and 0.9 consumer APIs, but not the other way around.
</code></pre>
<p>6)注意几个关键配置需要修改</p>
<pre><code>config :bootstrap_servers, :validate =&gt; :string, :default =&gt; &quot;localhost:9092&quot;
config :group_id, :validate =&gt; :string, :default =&gt; &quot;logstash&quot;
config :topics, :validate =&gt; :array, :default =&gt; [&quot;logstash&quot;]
config :consumer_threads, :validate =&gt; :number, :default =&gt; 1
</code></pre>
        </p>
    </div>
    

    

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="http://70data.net/tags/Kafka">#Kafka</a>
        
            <a class="tag" href="http://70data.net/tags/Logstash">#Logstash</a>
        
      
    </div>


        

<link rel="stylesheet" type="text/css" href="http://70data.net/css/katex.min.css" crossorigin="anonymous">
<script type="text/javascript" src="http://70data.net/js/katex.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="http://70data.net/js/auto-render.min.js"onload="renderMathInElement(document.body);" crossorigin="anonymous"></script>

        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

    

</div>



	<script src="http://70data.net/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww=" crossorigin="anonymous"></script>
</footer>
    </body>
</html>